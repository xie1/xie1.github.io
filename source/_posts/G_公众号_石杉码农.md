
##G_公众号_石杉码农

###一、石杉的架构笔记_2018年原创汇总
###1、并发系列
####1.1、volatile到底是什么？
	1、从修饰说起
	2、从它的JMM说起
	3、特性和synchronized比较说起
####1.2、Java 8如何优化CAS性能？
![Alt text](./1564540602479.png)
![Alt text](./1564061123140.png)
![Alt text](./1564061136015.png)

	
	1、因为高并发中的分段处理机制实际上是一个很常见和常用的并发优化手段
	2、实际上 Atomic原子类底层用的不是传统意义上的锁机制，而是用无锁化得CAS机制，通过CAS机制保证多线程修改一个数值的安全性

####1.3、谈谈你对AQS的理解？
	AbstractQueuedSynchronizer，抽象队列同步器
	结AQS就是一个并发包的基础组件，用来实现各种锁，各种同步组件的。它包含了state变量、加锁线程、等待队列等并发中的核心组件
![Alt text](./1564061655187.png)
![Alt text](./1564061669385.png)
![Alt text](./1564061681992.png)
![Alt text](./1564061695101.png)
![Alt text](./1564061708836.png)
![Alt text](./1564061722830.png)
####1.4、公平锁与非公平锁是啥？
	ReentrantLock lock = new ReentrantLock(true)
	
	公平锁策略：AQS的等待队列里，有没有人在排队啊？如果有人在排队的话，说明我前面有兄弟正想要加锁啊！
####1.5、微服务注册中心的读写锁优化？
![Alt text](./1564062391556.png)
####1.6、高并发优化实践/10倍请求压力来袭，你的系统会被击垮吗？——》重点理解
https://mp.weixin.qq.com/s/Foy1yBRWUGljOnJb09RVhg


###2、分布式
####2.1、TCC分布式事务的实现原理
![Alt text](./1564542433818.png)
![Alt text](./1564542550409.png)
![Alt text](./1564542560315.png)
	
	
![Alt text](./1564545237523.png)
![Alt text](./1564545476336.png)
![Alt text](./1564545514584.png)
![Alt text](./1564545626219.png)

		1、落地实现TCC分布式事务
			1、TCC实现阶段一：Try
				你的业务的主流程以及各个接口提供的业务含义，不是直接完成那个业务操作，而是完成一个Try的操作。
				1、可以引入TCC分布式事务框架，比如国内开源的ByteTCC、himly、tcc-transaction
			2、TCC实现阶段二：Confirm
			3、TCC实现阶段三：Cancel
####2.2、最终一致性分布式事务如何保障实际生产中99.99%高可用
![Alt text](./1564543019141.png)


	在使用TCC分布式事务主要应用于接口调用时同步的，如果是异步的话，可以考虑采用可靠消息最终一致性
	1、可靠消息最终一致性方案的核心流程
		1、上游服务投递消息
		2、下游服务接收消息
	2、可靠消息最终一致性方案的高可用保障生产实践——》暂定理解
		1、基于KV存储的队列支持的高可用降级方案
		
####2.3、Redis分布式锁的实现原理	（Redisson框架）


	在公司里落地生产环境用分布式锁时候，一定是会用开源类库，比如Redis分布式锁，一般就是用Redisson框架就好了。

![Alt text](./1564820642280.png)
	
	分布式锁的开源Redisson框架的实现机制：
	1、加锁机制：
		如果该客户端面对的是一个redis cluster集群，他首先会根据hash节点选择一台机器，紧接着，就会发送一段lua脚本到redis上
	2、锁互斥机制 
	3、watch自动延期机制
		要客户端1一旦加锁成功，就会启动一个watch dog看门狗，他是一个后台线程，会每隔10秒检查一下，如果客户端1还持有锁key，那么就会不断的延长锁key的生存时间
	4、可重入加锁机制
	5、释放锁机制
	6、上述Redis分布式锁的缺点
		redis master-slave架构的主从异步复制导致redis分布式锁的最大缺陷

####2.4、每秒上千订单场景下的分布式锁高并发优化实践
	延伸问题：电商高并发秒杀场景下的库存超卖解决方案，各种方案的优缺点以及实践，进而聊到分布式锁这个话题。
	库存超卖问题有很多技术解决方案：比如悲观锁，分布式锁，乐观锁，队列串行化，Redis原子操作，等等吧。

![Alt text](./1564821411435.png)
![Alt text](./1564821455705.png)

![Alt text](./1564821507676.png)

	通过分布式锁解决超卖的问题
	
	1、分布式锁的方案在高并发场景下：分段加锁，类似于ConcurrentHashMap
	把数据分成很多个段，每个段是一个单独的锁，所以多个线程过来并发修改数据的时候，可以并发的修改不同段的数据。不至于说，同一时间只能有一个线程独占修改ConcurrentHashMap中的数据
	
![Alt text](./1564822496343.png)
![Alt text](./1564822585328.png)


	2、分布式锁并发优化方案不足：
	首先，你得对一个数据分段存储，一个库存字段本来好好的，现在要分为20个分段库存字段；
	其次，你在每次处理库存的时候，还得自己写随机算法，随机挑选一个分段来处理；
	最后，如果某个分段中的数据不足了，你还得自动切换到下一个分段数据去处理。


####2.5、ZooKeeper分布式锁的实现原理（Curator这个开源框架）
	
###3、中间件
###4、面试必备
	提问时，必须要深入到你把某个业务细节讲清楚，以及结合这个业务细节到底是如何落地和设计技术方案的，如何使用各种技术在业务中的

	
	1、如何设计一个电商秒杀系统架构？
	2、如何设计一个消息推送系统架构？
	3、双11大促的时候如何设计系统的动态扩容/缩容的机制？
###5、线上经验总结
###6、亿级流量架构
