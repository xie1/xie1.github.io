---
title: 消息队列面试题
date: 2019-11-16 10:17:59
tags: 
categories: 
---
#一、*思维导图*
#*总知识点*
###1、什么是消息队列？——》已理解
	面试官心理分析
	其实面试官主要是想看看：
	第一，你知不知道你们系统里为什么要用消息队列这个东西？
	不少候选人，说自己项目里用了 Redis、MQ，但是其实他并不知道自己为什么要用这个东西。其实说白了，就是为了用而用，或者是别人设计的架构，他从头到尾都没思考过。
	没有对自己的架构问过为什么的人，一定是平时没有思考的人，面试官对这类候选人印象通常很不好。因为面试官担心你进了团队之后只会木头木脑的干呆活儿，不会自己思考。
	
	第二，你既然用了消息队列这个东西，你知不知道用了有什么好处&坏处？
	你要是没考虑过这个，那你盲目弄个 MQ 进系统里，后面出了问题你是不是就自己溜了给公司留坑？你要是没考虑过引入一个技术可能存在的弊端和风险，面试官把这类候选人招进来了，基本可能就是挖坑型选手。就怕你干 1 年挖一堆坑，自己跳槽了，给公司留下无穷后患。
	
	第三，既然你用了 MQ，可能是某一种 MQ，那么你当时做没做过调研？
	你别傻乎乎的自己拍脑袋看个人喜好就瞎用了一个 MQ，比如 Kafka，甚至都从没调研过业界流行的 MQ 到底有哪几种。每一个 MQ 的优点和缺点是什么。每一个 MQ 没有绝对的好坏，但是就是看用在哪个场景可以扬长避短，利用其优势，规避其劣势。
	如果是一个不考虑技术选型的候选人招进了团队，leader 交给他一个任务，去设计个什么系统，他在里面用一些技术，可能都没考虑过选型，最后选的技术可能并不一定合适，一样是留坑


	消息队列是，消息中间件，它通过消费者对队列中的消息进行消费。引起消息队列是为了解决应用场景，解耦，异步，削峰。解决分布式事务的最终一致性问题。
	弊端：增加系统架构的复杂性，不易于系统的问题的定位===


###2、为什么使用消息队列？——》已理解
		其实就是问问你的消息队列都有哪些使用场景，然后你的项目里具体是在什么场景，说说你在整个场景里用消息队列是什么。
		面试官（你们公司有个什么业务场景，这个业务场景有什么技术挑战，如果不用MQ可能会有很麻烦，但是你现在用了MQ之后带给了你很多的好处）
		消息队列常见的场景，比较核心:解耦、异步、削峰
	
解耦：
1、未使用MQ，系统之间的消息队列是如下图
![Alt text](./QQ截图20190518215918.png)

2、使用MQ		
![Alt text](./QQ截图20190518220121.png)
				
		总结：通过一个MQ，Pub/Sub发布订阅消息这么一个模型，A系统就可以跟其他的系统彻底的解耦
		面试技巧：你需要去考虑一下你负责的系统中是否有类似的场景，就是一个系统或者一个模块，调用了多个系统或者模块，相互之间的调用很复杂，维护起来很麻烦。你需要考虑在你项目里，是不是可以运用这个MQ去进行系统的解耦。
		自身系统体现：调用一个消息项目，消息项目在通过MQ，去调用微信的系统的，发送微信模板消息。
	
异步：
1、未使用MQ
![Alt text](./QQ截图20190518223615.png)

 2、使用MQ
![Alt text](./QQ截图20190518223626.png)

削峰：
 1、使用MQ
![Alt text](./QQ截图20190518224240.png)

###3、消息队列有什么优缺点？——》已理解
	1、优点：在特殊场景下的好处，解耦，异步，削峰
	2、缺点：
		1、系统可用性降低（如何保证消息队列的高可用）
			系统引入的外部依赖越多，越容易挂掉
		2、系统复杂度提高（如何保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性）
		3、一致性问题
			A系统处理完了直接返回成功，人都以为你请求就成功，但是要是BCD三个系统，BD两个系统写入成功，但是C系统写入失败
			
###4、Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？——》已理解
![Alt text](./1558358778384.png)

	综上，各种对比之后，有如下建议：

	1、一般的业务系统要引入 MQ，最早大家都用 ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃，所以大家还是算了吧，我个人不推荐用这个了；
	
	2、后来大家开始用 RabbitMQ，但是确实 erlang 语言阻止了大量的 Java 工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是确实人家是开源的，比较稳定的支持，活跃度也高；
	
	3、不过现在确实越来越多的公司会去用 RocketMQ，确实很不错，毕竟是阿里出品，但社区可能有突然黄掉的风险（目前 RocketMQ 已捐给 Apache，但 GitHub 上的活跃度其实不算高）对自己公司技术实力有绝对自信的，推荐用 RocketMQ，否则回去老老实实用 RabbitMQ 吧，人家有活跃的开源社区，绝对不会黄。
	
	4、所以中小型公司，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；大型公司，基础架构研发实力较强，用 RocketMQ 是很好的选择。
	
	5、如果是大数据领域的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范



	比较：
	1、单机吐量，activeMQ和rabbitMQ在W级，RocketMQ和kafka在10W级
	2、时效性，除了rabbitMQ在微秒级，其他都是在ms级
	3、可用性，activeMQ和rabbitMQ在主从架构，可用性高，RocketMQ和kafka在是分布式框架，非常高
	4、消息可靠性，activeMQ有较低的丢失数据，其他三个基本不丢
	5、功能支持：activeMQ功能相对比较稳定==

	
###5、如何保证消息队列的高可用？——》已理解
	1、面试官心理分析
	如果有人问到你 MQ 的知识，高可用是必问的。上一讲提到，MQ 会导致系统可用性降低。所以只要你用了 MQ，接下来问的一些要点肯定就是围绕着 MQ 的那些缺点怎么来解决了。
	要是你傻乎乎的就干用了一个 MQ，各种问题从来没考虑过，那你就杯具了，面试官对你的感觉就是，只会简单使用一些技术，没任何思考，马上对你的印象就不太好了。这样的同学招进来要是做个 20k 薪资以内的普通小弟还凑合，要是做薪资 20k+ 的高工，那就惨了，让你设计个系统，里面肯定一堆坑，出了事故公司受损失，团队一起背锅

	2、面试题剖析：
	问的是 MQ 的高可用性怎么保证？这样就是你用过哪个 MQ，你就说说你对那个 MQ 的高可用性的理解


	RabbitMQ的高可用性
		RabbitMQ比较有代表性，因为是基于主从（非分布式）做的高可用性，
		RabbitMQ有三种模式：单机模式，普通集群模式，镜像集群模式
		1、单机模式一般属于Demo级别
		2、普通集群模式（无高可用性）
			在多台机器上启动多个RabbitMQ实例，每个机器启动一个。你创建的queue，只能放会在一个RabbitMQ实例上，每个实例都同步queue的元数据（元数据可用认为是queue的一些配置信息，通过RabbitMQ实例，可用找到queue所在的实例）你消费的时候，实际上如果连接到另外一个实例，那么那个实例会从queue所在实例上拉取数据过来
![Alt text](./1559357065491.png)


		3、镜像集群模式（高可用性）
			在镜像集群模式下，你创建的queue，无论元数据还是queue里的消息都会存在多个实例上，就是说，每个RabbitMQ节点都有这个queue的一个完整镜像，包含queue的全部数据。然后每次你写消息queue的时候，都会自动把消息同步到多个实例queue
![Alt text](./1559357348946.png)
	
	开启方式：在RabbitMQ的管理后台，新增一个镜像集群的策略


	
###6、如何保证消息不被重复消费或保证消息的幂等性？——》已理解
	1、面试官心理分析：
		其实这是很常见的一个问题，这俩问题基本可以连起来问。既然是消费消息，那肯定要考虑会不会重复消费？能不能避免重复消费？或者重复消费了也别造成系统异常可以吗？这个是 MQ 领域的基本问题，其实本质上还是问你使用消息队列如何保证幂等性，这个是你架构里要考虑的一个问题

	2、面试题剖析
	2.1、说下可能会出现哪些重复消费问题。
		首先，比如 RabbitMQ、RocketMQ、Kafka，都有可能会出现消息重复消费的问题，正常。因为这问题通常不是 MQ 自己保证的，是由我们开发来保证的。挑一个 Kafka 来举个例子，说说怎么重复消费吧。
	
	Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。
	
	但是凡事总有意外，比如我们之前生产经常遇到的，就是你有时候重启系统，看你怎么重启了，如果碰到点着急的，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset，尴尬了。重启之后，少数消息会再次消费一次
![Alt text](./1559362299181.png)


	2.2、重复消费之后，如何考虑幂等性？
		幂等性，通俗的说，就一个数据或者一个请求，给你重复来几次，你得确保对应的数据是不会改变的，不会出错。
![Alt text](./1559362468336.png)


###7、如何保证消息可靠传输或者处理消息丢失问题？——》已理解
	1、面试官心理分析
		用MQ有个基本原则，就是数据不能多一条，也不能少一条，不能多，就是前面说的重复消费和幂等性问题，不能少即不能把数据搞丢
	2、面试题剖析
		数据的丢失问题，可能存在于生产者、 MQ、消费者中，可以从RabbitMQ和Kafka分别来分析
		RabbitMQ
![Alt text](./1559368904661.png)
![Alt text](./1559368959171.png)
![Alt text](./1559368991713.png)
![Alt text](./1559369034191.png)



###8、如何保证消息顺序性？——》已理解
	1、面试官的心理分析：
		其实这个也是MQ的时候必问问题，查看你了不了解消息的顺序性，还有如何保证MQ的顺序性？生产系统常见问题
	2、面试题剖析
![Alt text](./1559371074449.png)
![Alt text](./1559371121657.png)

###9、如何保证业务执行和消息发送的一致性？
     （一致性产生消息的业务动作与消息发送的一一致，业务成功，消息一定要发送出去）
          最终解决方案：发送消息的正向流程和检查业务操作结果的反向流程合起来，就是解决业务操作与发送消息一致性的方案
          1、发送消息给消息中间件
          2、消息中间件入库消息（消息状态待处理）
          3、消息中间件返回结果
          4、业务操作
          5、发送业务操作结果给消息中间件
          6、更改存储中消息状态（消息状态待发送）
	
###10、如何解决消息队列的延时以及过期失效问题？
	1、面试官心理分析：
	你看这问法，其实本质针对的场景，都是说，可能你的消费端出了问题，不消费了；或者消费的速度极其慢。接着就坑爹了，可能你的消息队列集群的磁盘都快写满了，都没人消费，这个时候怎么办？或者是这整个就积压了几个小时，你这个时候怎么办？或者是你积压的时间太长了，导致比如 RabbitMQ 设置了消息过期时间后就没了怎么办？
	
	所以就这事儿，其实线上挺常见的，一般不出，一出就是大 case。一般常见于，举个例子，消费端每次消费之后要写 mysql，结果 mysql 挂了，消费端 hang 那儿了，不动了；或者是消费端出了个什么岔子，导致消费速度极其慢

	2、面试题的剖析
		关于这个事儿，我们一个一个来梳理吧，先假设一个场景，我们现在消费端出故障了，然后大量消息在 mq 里积压，现在出事故了，慌了
![Alt text](./1559375925346.png)

###11、如果让你写一个消息队列，该如何进行架构设计？说一下你的思路？
	1、面试官心理分析：
		其实聊到这个问题，一般面试官要考察两块：
	你有没有对某一个消息队列做过较为深入的原理的了解，或者从整体了解把握住一个消息队列的架构原理。
	看看你的设计能力，给你一个常见的系统，就是消息队列系统，看看你能不能从全局把握一下整体架构设计，给出一些关键点出来。
	说实话，问类似问题的时候，大部分人基本都会蒙，因为平时从来没有思考过类似的问题，大多数人就是平时埋头用，从来不去思考背后的一些东西。类似的问题，比如，如果让你来设计一个 Spring 框架你会怎么做？如果让你来设计一个 Dubbo 框架你会怎么做？如果让你来设计一个 MyBatis 框架你会怎么做？
	2、面试题剖析：
		其实回答这类问题，说白了，不求你看过那技术的源码，起码你要大概知道那个技术的基本原理、核心组成部分、基本架构构成，然后参照一些开源的技术把一个系统设计出来的思路说一下就好。

	比如说这个消息队列系统，我们从以下几个角度来考虑一下：
	
	首先这个 mq 得支持可伸缩性吧，就是需要的时候快速扩容，就可以增加吞吐量和容量，那怎么搞？设计个分布式的系统呗，参照一下 kafka 的设计理念，broker -> topic -> partition，每个 partition 放一个机器，就存一部分数据。如果现在资源不够了，简单啊，给 topic 增加 partition，然后做数据迁移，增加机器，不就可以存放更多数据，提供更高的吞吐量了？
	
	其次你得考虑一下这个 mq 的数据要不要落地磁盘吧？那肯定要了，落磁盘才能保证别进程挂了数据就丢了。那落磁盘的时候怎么落啊？顺序写，这样就没有磁盘随机读写的寻址开销，磁盘顺序读写的性能是很高的，这就是 kafka 的思路。
	
	其次你考虑一下你的 mq 的可用性啊？这个事儿，具体参考之前可用性那个环节讲解的 kafka 的高可用保障机制。多副本 -> leader & follower -> broker 挂了重新选举 leader 即可对外服务。
	
	能不能支持数据 0 丢失啊？可以的，参考我们之前说的那个 kafka 数据零丢失方案。
	
	mq 肯定是很复杂的，面试官问你这个问题，其实是个开放题，他就是看看你有没有从架构角度整体构思和设计的思维以及能力。确实这个问题可以刷掉一大批人，因为大部分人平时不思考这些东西