##V_Java 工程师面试突击第1季(上)2周

###1、分布式系统
####1.1、为什么要进行系统拆分
#####1.1.1、为什么要进行系统拆分？如何进行系统拆分？拆分后不用 dubbo 可以吗？
	1、面试官心理分析：
		从这个问题开始就进行分布式系统的环节的提问
	
	2、面试题剖析
		为什么要将系统进行拆分？
	网上查查，答案极度零散和复杂，很琐碎，原因一大坨。但是我这里给大家直观的感受：
	
	要是不拆分，一个大系统几十万行代码，20 个人维护一份代码，简直是悲剧啊。代码经常改着改着就冲突了，各种代码冲突和合并要处理，非常耗费时间；经常我改动了我的代码，你调用了我的，导致你的代码也得重新测试，麻烦的要死；然后每次发布都是几十万行代码的系统一起发布，大家得一起提心吊胆准备上线，几十万行代码的上线，可能每次上线都要做很多的检查，很多异常问题的处理，简直是又麻烦又痛苦；而且如果我现在打算把技术升级到最新的 spring 版本，还不行，因为这可能导致你的代码报错，我不敢随意乱改技术。
	
	假设一个系统是 20 万行代码，其中 A 在里面改了 1000 行代码，但是此时发布的时候是这个 20 万行代码的大系统一块儿发布。就意味着 20 万上代码在线上就可能出现各种变化，20 个人，每个人都要紧张地等在电脑面前，上线之后，检查日志，看自己负责的那一块儿有没有什么问题。
	
	A 就检查了自己负责的 1 万行代码对应的功能，确保 ok 就闪人了；结果不巧的是，A 上线的时候不小心修改了线上机器的某个配置，导致另外 B 和 C 负责的 2 万行代码对应的一些功能，出错了。
	
	几十个人负责维护一个几十万行代码的单块应用，每次上线，准备几个礼拜，上线 -> 部署 -> 检查自己负责的功能。
	
	拆分了以后，整个世界清爽了，几十万行代码的系统，拆分成 20 个服务，平均每个服务就 1~2 万行代码，每个服务部署到单独的机器上。20 个工程，20 个 git 代码仓库，20 个开发人员，每个人维护自己的那个服务就可以了，是自己独立的代码，跟别人没关系。再也没有代码冲突了，爽。每次就测试我自己的代码就可以了，爽。每次就发布我自己的一个小服务就可以了，爽。技术上想怎么升级就怎么升级，保持接口不变就可以了，真爽。
	
	所以简单来说，一句话总结，如果是那种代码量多达几十万行的中大型项目，团队里有几十个人，那么如果不拆分系统，开发效率极其低下，问题很多。但是拆分系统之后，每个人就负责自己的一小部分就好了，可以随便玩儿随便弄。分布式系统拆分之后，可以大幅度提升复杂系统大型团队的开发效率。
	
	但是同时，也要提醒的一点是，系统拆分成分布式系统之后，大量的分布式系统面临的问题也是接踵而来，所以后面的问题都是在围绕分布式系统带来的复杂技术挑战在说。
	
	如何进行系统拆分？
	这个问题说大可以很大，可以扯到领域驱动模型设计上去，说小了也很小，我不太想给大家太过于学术的说法，因为你也不可能背这个答案，过去了直接说吧。还是说的简单一点，大家自己到时候知道怎么回答就行了。
	
	系统拆分为分布式系统，拆成多个服务，拆成微服务的架构，是需要拆很多轮的。并不是说上来一个架构师一次就给拆好了，而以后都不用拆。
	
	第一轮；团队继续扩大，拆好的某个服务，刚开始是 1 个人维护 1 万行代码，后来业务系统越来越复杂，这个服务是 10 万行代码，5 个人；第二轮，1个服务 -> 5个服务，每个服务 2 万行代码，每人负责一个服务。
	
	如果是多人维护一个服务，最理想的情况下，几十个人，1 个人负责 1 个或 2~3 个服务；某个服务工作量变大了，代码量越来越多，某个同学，负责一个服务，代码量变成了 10 万行了，他自己不堪重负，他现在一个人拆开，5 个服务，1 个人顶着，负责 5 个人，接着招人，2 个人，给那个同学带着，3 个人负责 5 个服务，其中 2 个人每个人负责 2 个服务，1 个人负责 1 个服务。
	
	个人建议，一个服务的代码不要太多，1 万行左右，两三万撑死了吧。
	
	大部分的系统，是要进行多轮拆分的，第一次拆分，可能就是将以前的多个模块该拆分开来了，比如说将电商系统拆分成订单系统、商品系统、采购系统、仓储系统、用户系统，等等吧。
	
	但是后面可能每个系统又变得越来越复杂了，比如说采购系统里面又分成了供应商管理系统、采购单管理系统，订单系统又拆分成了购物车系统、价格系统、订单管理系统。
	
	扯深了实在很深，所以这里先给大家举个例子，你自己感受一下，核心意思就是根据情况，先拆分一轮，后面如果系统更复杂了，可以继续分拆。你根据自己负责系统的例子，来考虑一下就好了。
	
	拆分后不用 dubbo 可以吗？
	当然可以了，大不了最次，就是各个系统之间，直接基于 spring mvc，就纯 http 接口互相通信呗，还能咋样。但是这个肯定是有问题的，因为 http 接口通信维护起来成本很高，你要考虑超时重试、负载均衡等等各种乱七八糟的问题，比如说你的订单系统调用商品系统，商品系统部署了 5 台机器，你怎么把请求均匀地甩给那 5 台机器？这不就是负载均衡？你要是都自己搞那是可以的，但是确实很痛苦。
	
	所以 dubbo 说白了，是一种 rpc 框架，就是说本地就是进行接口调用，但是 dubbo 会代理这个调用请求，跟远程机器网络通信，给你处理掉负载均衡、服务实例上下线自动感知、超时重试等等乱七八糟的问题。那你就不用自己做了，用 dubbo 就可以了。

####1.2、分布式服务框架（Dubbo）
#####1.2.1、说一下的 dubbo 的工作原理？注册中心挂了可以继续通信吗？说说一次 rpc 请求的流程？
	1、面试官心理分析：
	MQ、ES、Redis、Dubbo，上来先问你一些思考性的问题、原理，比如 kafka 高可用架构原理、es 分布式架构原理、redis 线程模型原理、Dubbo 工作原理；之后就是生产环境里可能会碰到的一些问题，因为每种技术引入之后生产环境都可能会碰到一些问题；再来点综合的，就是系统设计，比如让你设计一个 MQ、设计一个搜索引擎、设计一个缓存、设计一个 rpc 框架等等。
	
	那既然开始聊分布式系统了，自然重点先聊聊 dubbo 了，毕竟 dubbo 是目前事实上大部分公司的分布式系统的 rpc 框架标准，基于 dubbo 也可以构建一整套的微服务架构。但是需要自己大量开发。
	
	当然去年开始 spring cloud 非常火，现在大量的公司开始转向 spring cloud 了，spring cloud 人家毕竟是微服务架构的全家桶式的这么一个东西。但是因为很多公司还在用 dubbo，所以 dubbo 肯定会是目前面试的重点，何况人家 dubbo 现在重启开源社区维护了，捐献给了 apache，未来应该也还是有一定市场和地位的。
	
	既然聊 dubbo，那肯定是先从 dubbo 原理开始聊了，你先说说 dubbo 支撑 rpc 分布式调用的架构啥的，然后说说一次 rpc 请求 dubbo 是怎么给你完成的，对吧

	2、面试题剖析：
![Alt text](./1559445020630.png)
![Alt text](./1559445035791.png)
#####1.2.2、dubbo 支持哪些通信协议？支持哪些序列化协议？说一下 Hessian 的数据结构？PB 知道吗？为什么 PB 的效率是最高的？
	1、面试官心理分析：
		上一个问题，说说 dubbo 的基本工作原理，那是你必须知道的，至少要知道 dubbo 分成哪些层，然后平时怎么发起 rpc 请求的，注册、发现、调用，这些是基本的。
	
	接着就可以针对底层进行深入的问问了，比如第一步就可以先问问序列化协议这块，就是平时 RPC 的时候怎么走的？
	2、面试题剖析：
![Alt text](./1559447305987.png)
![Alt text](./1559447321806.png)
![Alt text](./1559447340092.png)
#####1.2.3、dubbo 负载均衡策略和集群容错策略都有哪些？动态代理策略呢？		
	1、面试官心理分析：
			继续深问吧，这些都是用 dubbo 必须知道的一些东西，你得知道基本原理，知道序列化是什么协议，还得知道具体用 dubbo 的时候，如何负载均衡，如何高可用，如何动态代理。
	
	说白了，就是看你对 dubbo 熟悉不熟悉：
		1、dubbo 工作原理：服务注册、注册中心、消费者、代理通信、负载均衡；
		2、网络通信、序列化：dubbo 协议、长连接、NIO、hessian 序列化协议；
		3、负载均衡策略、集群容错策略、动态代理策略：dubbo 跑起来的时候一些功能是如何运转的？怎么做负载均衡？怎么做集群容错？怎么生成动态代理？
		4、dubbo SPI 机制：你了解不了解 dubbo 的 SPI 机制？如何基于 SPI 机制对 dubbo 进行扩展？

	2、面试题剖析：
![Alt text](./1559447845477.png)
![Alt text](./1559447866588.png)
![Alt text](./1559447878504.png)
#####1.2.4、dubbo 的 spi 思想是什么？
	1、面试官心理分析
	继续深入问呗，前面一些基础性的东西问完了，确定你应该都 ok，了解 dubbo 的一些基本东西，那么问个稍微难一点点的问题，就是 spi，先问问你 spi 是啥？然后问问你 dubbo 的 spi 是怎么实现的？
	其实就是看看你对 dubbo 的掌握如何


	2、面试题剖析：
![Alt text](./1559455789788.png)
![Alt text](./1559455812568.png)
![Alt text](./1559455827839.png)
![Alt text](./1559455842115.png)

#####1.2.5、如何基于 dubbo 进行服务治理、服务降级、失败重试以及超时重试？
	1、面试官心理分析：
	服务治理，这个问题如果问你，其实就是看看你有没有服务治理的思想，因为这个是做过复杂微服务的人肯定会遇到的一个问题。
	
	服务降级，这个是涉及到复杂分布式系统中必备的一个话题，因为分布式系统互相来回调用，任何一个系统故障了，你不降级，直接就全盘崩溃？那就太坑爹了吧。
	
	失败重试，分布式系统中网络请求如此频繁，要是因为网络问题不小心失败了一次，是不是要重试？
	
	超时重试，跟上面一样，如果不小心网络慢一点，超时了，如何重试？
	2、面试题剖析：
![Alt text](./1559461510217.png)
![Alt text](./1559461528802.png)
![Alt text](./1559461545898.png)
![Alt text](./1559461554384.png)
#####1.2.6、分布式服务接口的幂等性如何设计（比如不能重复扣款）？
	1、面试官心理分析：
		从这个问题开始，面试官就已经进入了实际的生产问题的面试了。
	一个分布式系统中的某个接口，该如何保证幂等性？这个事儿其实是你做分布式系统的时候必须要考虑的一个生产环境的技术问题。啥意思呢？
	你看，假如你有个服务提供一些接口供外部调用，这个服务部署在了 5 台机器上，接着有个接口就是付款接口。然后人家用户在前端上操作的时候，不知道为啥，总之就是一个订单不小心发起了两次支付请求，然后这俩请求分散在了这个服务部署的不同的机器上，好了，结果一个订单扣款扣两次。
	或者是订单系统调用支付系统进行支付，结果不小心因为网络超时了，然后订单系统走了前面我们看到的那个重试机制，咔嚓给你重试了一把，好，支付系统收到一个支付请求两次，而且因为负载均衡算法落在了不同的机器上，尴尬了。。。
	所以你肯定得知道这事儿，否则你做出来的分布式系统恐怕容易埋坑
	2、面试题剖析：
![Alt text](./1559461678065.png)


#####1.2.7、分布式服务接口请求的顺序性如何保证？
	1、面试官心理分析：
	其实分布式系统接口的调用顺序，也是个问题，一般来说是不用保证顺序的。但是有时候可能确实是需要严格的顺序保证。给大家举个例子，你服务 A 调用服务 B，先插入再删除。好，结果俩请求过去了，落在不同机器上，可能插入请求因为某些原因执行慢了一些，导致删除请求先执行了，此时因为没数据所以啥效果也没有；结果这个时候插入请求过来了，好，数据插入进去了，那就尴尬了。
	本来应该是 “先插入 -> 再删除”，这条数据应该没了，结果现在 “先删除 -> 再插入”，数据还存在，最后你死都想不明白是怎么回事。
	所以这都是分布式系统一些很常见的问题。
	2、面试题剖析：
![Alt text](./1559463003607.png)
![Alt text](./1559463016688.png)


#####1.2.8、如何自己设计一个类似 Dubbo 的 RPC 框架？
	1、面试官心理分析：
	说实话，就这问题，其实就跟问你如何自己设计一个 MQ 一样的道理，就考两个：
	你有没有对某个 rpc 框架原理有非常深入的理解。
	你能不能从整体上来思考一下，如何设计一个 rpc 框架，考考你的系统设计能力。
	2、面试题剖析：
![Alt text](./1559463149865.png)

####1.3、分布式锁（Zookeeper）
######1.3.1、zookeeper 都有哪些使用场景？
	1、面试官心理分析
			现在聊的 topic 是分布式系统，面试官跟你聊完了 dubbo 相关的一些问题之后，已经确认你对分布式服务框架/RPC框架基本都有一些认知了。那么他可能开始要跟你聊分布式相关的其它问题了。
	
	分布式锁这个东西，很常用的，你做 Java 系统开发，分布式系统，可能会有一些场景会用到。最常用的分布式锁就是基于 zookeeper 来实现的。
	
	其实说实话，问这个问题，一般就是看看你是否了解 zookeeper，因为 zookeeper 是分布式系统中很常见的一个基础系统。而且问的话常问的就是说 zookeeper 的使用场景是什么？看你知道不知道一些基本的使用场景。但是其实 zookeeper 挖深了自然是可以问的很深很深的

	2、面试题剖析
![Alt text](./1559465392063.png)
![Alt text](./1559465406404.png)
![Alt text](./1559465415592.png)
![Alt text](./1559465423205.png)

######1.3.2、一般实现分布式锁都有哪些方式？使用 redis 如何设计分布式锁？使用 zk 来设计分布式锁可以吗？这两种分布式锁的实现方式哪种效率比较高？
	1、面试官心理分析
		因为在分布式系统开发中，分布式锁的使用场景还是很常见的。
	2、面试题剖析：
![Alt text](./1559480159251.png)
![Alt text](./1559480180666.png)
![Alt text](./1559480213746.png)
[Zookeeper分布式锁](https://github.com/doocs/advanced-java/blob/master/docs/distributed-system/distributed-lock-redis-vs-zookeeper.md)

	redis 分布式锁和 zk 分布式锁的对比
	redis 分布式锁，其实需要自己不断去尝试获取锁，比较消耗性能。
	zk 分布式锁，获取不到锁，注册个监听器即可，不需要不断主动尝试获取锁，性能开销较小。
	另外一点就是，如果是 redis 获取锁的那个客户端 出现 bug 挂了，那么只能等待超时时间之后才能释放锁；而 zk 的话，因为创建的是临时 znode，只要客户端挂了，znode 就没了，此时就自动释放锁。
	
	redis 分布式锁大家没发现好麻烦吗？遍历上锁，计算时间等等......zk 的分布式锁语义清晰实现简单。
	
	所以先不分析太多的东西，就说这两点，我个人实践认为 zk 的分布式锁比 redis 的分布式锁牢靠、而且模型简单易用
####1.4、分布式事务
####1.5、分布式会话
#####1.5.1、集群部署时的分布式 session 如何实现？
	1、面试官心理分析：
			面试官问了你一堆 dubbo 是怎么玩儿的，你会玩儿 dubbo 就可以把单块系统弄成分布式系统，然后分布式之后接踵而来的就是一堆问题，最大的问题就是分布式事务、接口幂等性、分布式锁，还有最后一个就是分布式 session。
	
	当然了，分布式系统中的问题何止这么一点，非常之多，复杂度很高，这里只是说一下常见的几个问题，也是面试的时候常问的几个

	2、面试题剖析：
![Alt text](./1559484217883.png)
![Alt text](./1559484230605.png)
![Alt text](./1559484241088.png)
![Alt text](./1559484253279.png)


----------


###2、高并发架构
####2.1、如何设计一个高并发系统
####2.2、消息队列
####2.3、搜索引擎
####2.4、缓存
#####2.4.1、项目中缓存是如何使用的？为什么要用缓存？缓存使用不当会造成什么后果？
	1、面试官心理分析：
		这个问题，互联网公司必问，要是一个人连缓存都不太清楚，那确实比较尴尬。
	只要问到缓存，上来第一个问题，肯定是先问问你项目哪里用了缓存？为啥要用？不用行不行？如果用了以后可能会有什么不良的后果？
	这就是看看你对缓存这个东西背后有没有思考，如果你就是傻乎乎的瞎用，没法给面试官一个合理的解答，那面试官对你印象肯定不太好，觉得你平时思考太少，就知道干活儿

	2、面试题的剖析
		1、项目中缓存是如何使用的？
			可以参考苗木超市的列表和采购单列表
		2、为什么要用缓存？
![Alt text](./1559378468429.png)

#####2.4.2、redis和memcached有什么区别？redis的线程模型是什么？为什么redis单线程却能支持高并发？
	1、面试官的心理分析：
	 这个是问 redis 的时候，最基本的问题吧，redis 最基本的一个内部原理和特点，就是 redis 实际上是个单线程工作模型，你要是这个都不知道，那后面玩儿 redis 的时候，出了问题岂不是什么都不知道？
	
	还有可能面试官会问问你 redis 和 memcached 的区别，但是 memcached 是早些年各大互联网公司常用的缓存方案，但是现在近几年基本都是 redis，没什么公司用 memcached 了。

	2、面试题剖析：
	redis 和 memcached 有啥区别？
	redis 支持复杂的数据结构
	redis 相比 memcached 来说，拥有更多的数据结构，能支持更丰富的数据操作。如果需要缓存能够支持更复杂的结构和操作， redis 会是不错的选择。
	
	redis 原生支持集群模式
	在 redis3.x 版本中，便能支持 cluster 模式，而 memcached 没有原生的集群模式，需要依靠客户端来实现往集群中分片写入数据。
	
	性能对比
	由于 redis 只使用单核，而 memcached 可以使用多核，所以平均每一个核上 redis 在存储小数据时比 memcached 性能更高。而在 100k 以上的数据中，memcached 性能要高于 redis。虽然 redis 最近也在存储大数据的性能上进行优化，但是比起 memcached，还是稍有逊色。
![Alt text](./1559381894148.png)
![Alt text](./1559381907310.png)


#####2.4.3、redis 都有哪些数据类型？分别在哪些场景下使用比较合适？
	1、面试官心理分析：
		其实问这个问题，主要有两个原因：
	看看你到底有没有全面的了解 redis 有哪些功能，一般怎么来用，啥场景用什么，就怕你别就会最简单的 KV 操作；
	看看你在实际项目里都怎么玩儿过 redis
	2、面试题剖析
![Alt text](./1559382757442.png)
![Alt text](./1559382777390.png)
![Alt text](./1559382798389.png)
![Alt text](./1559382807586.png)

#####2.4.4、redis的过期策略有哪些？内存淘汰机制有哪些？手写一些LRU代码实现？
	1、面试官心理分析
		如果你连这个问题都不知道，上来就懵了，回答不出来，那线上你写代码的时候，想当然的认为写进 redis 的数据就一定会存在，后面导致系统各种 bug，谁来负责？

	常见的有两个问题：
	
	往 redis 写入的数据怎么没了？
	可能有同学会遇到，在生产环境的 redis 经常会丢掉一些数据，写进去了，过一会儿可能就没了。我的天，同学，你问这个问题就说明 redis 你就没用对啊。redis 是缓存，你给当存储了是吧？
	
	啥叫缓存？用内存当缓存。内存是无限的吗，内存是很宝贵而且是有限的，磁盘是廉价而且是大量的。可能一台机器就几十个 G 的内存，但是可以有几个 T 的硬盘空间。redis 主要是基于内存来进行高性能、高并发的读写操作的。
	
	那既然内存是有限的，比如 redis 就只能用 10G，你要是往里面写了 20G 的数据，会咋办？当然会干掉 10G 的数据，然后就保留 10G 的数据了。那干掉哪些数据？保留哪些数据？当然是干掉不常用的数据，保留常用的数据了。
	
	数据明明过期了，怎么还占用着内存？
	这是由 redis 的过期策略来决定

	2、面试题剖析
![Alt text](./1559386816035.png)
![Alt text](./1559386843881.png)
![Alt text](./1559386856819.png)
#####2.4.5、如何保证 Redis 高并发、高可用？Redis 的主从复制原理能介绍一下么？Redis 的哨兵原理能介绍一下么？
####2.5、分库分表
####2.6、读写分离

###3、高可用架构
####3.1、如何设计一个高可用的系统
####3.2、限流
####3.1、熔断
####3.1、降级

