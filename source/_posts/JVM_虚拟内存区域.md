---
title: JVM_虚拟内存区域(一)
date: 2018-11-27 15:02:55
tags: JVM
categories: Java基础

---
##虚拟机内存区域与内存溢出异常
	问题分析：
	1、理解运行的数据区域划分为几块-->概念
	2、每一块区域主要存放的是什么，有什么功能-->特性的理解
	3、每一块最有可能出现的问题，例如内存溢出或泄露之类的-->异常
	4、如何定位这类问题的出现及解决，如何调整区域的设置-->扩展
	5、此块区域与其他模块的之间的关系（垃圾回收机制等）-->关系

		


#一、*思维导图*
[http://naotu.baidu.com/file/424e5783104cee1155554921f0ca3cd7](http://naotu.baidu.com/file/424e5783104cee1155554921f0ca3cd7)	
#二、*总知识点*
### 1、运行时的数据区域划分
![](https://i.imgur.com/2OEJXlr.png)
#### 1.1、程序计数器
		1、存放内容：正在执行的虚拟机字节码指令的地址
		2、特点：线程私有，每个线程都有自己的程序计数器	
#### 1.2、Java虚拟机栈
		1、存放内容
			1、描述Java方法执行的内存模型（栈帧）：
					1、局部变量表
					2、操作数栈
						字节码指令，先入后出
						 调用其它的方法的时候是通过操作数栈来传递参数的
					3、动态连接
					4、返回地址，方法退出的过程实际上就等于把当前栈帧出栈，退出可能执行的操作
						退出种类
							执行引擎遇到人员一个方法返回的字节码指令
							方法执行过程中遇到了异常，而且这个异常没有在方法体内得到处理
			2、局部变量表：
					1、存放编译期间可知的各种基本类型，对象引用和returnAdress类型（指向字节码地址）
					2、单位64位的long和double占2slots的局部变量空间，其他类型1slot
							
		2、特点：线程私用
		3、异常状况
				1、请求栈深度大于虚拟机允许的深度，将抛出StackOverflowError异常
				2、无法申请到足够的内存，将抛出OutOfMemoryError异常

#### 1.3、本地方法栈
		类似于虚拟机栈，而本地方法则为虚拟机使用到的Native方法服务

#### 1.4、Java堆 
		存放对象实例（通过-Xmx（最大值）和-Xms（初始值）控制）
		1、存放内容：对象实例及几乎所有的对象实例和数组都要再堆上分配
		2、分区
			1、新生代
			 Eden空间
			 From Survivor空间
			 To Survivor空间
			2、老年代
		3、特点:线程共享
		4、异常状况：将抛出OutOfMemoryError异常
#### 1.5、方法区
		存储已被虚拟机加载的类信息、常量、静态方法
		1、存放内容
			已被虚拟机加载类信息
			常量
			静态变量
			即时编译后的代码
		2、特点 :线程共享,可以选择不实现垃圾收集
		3、异常状况 : 将抛出OutOfMemoryError异常
		4、运行时常量池
### 2、HotSpot虚拟机对象
#### 2.1、对象的创建
##### 2.1.1、第一步
			1、检查常量池
			2、检查类加载，解析，初始化
			3、指针策略 :CAS 和 TLAB
 			4、空间分配 ：指针碰撞 和 空闲列表
			5、初始化内存空间为零值
			6、设置对象属性
			7、完成对象创建

##### 2.1.2、第二步
			1、设置对象信息
			2、初始化类信息

#### 2.2、对象的内存布局
		1、对象头
			1、自身信息
				1、哈希码
				2、 GC分代年龄
				3、 锁状态标志
				4、 线程持有的锁
				5、 偏向线程ID
				6、 偏向时间戳
			2、类型指针：指向它的类元数据的指针
		2、实例数据
		3、对齐填充
#### 2.3、对象的访问定位
		1、方式
			1、句柄
			2、直接指针
		2、区别

### 3、实战：OutOfMemoryError异常
#### 3.1、Java堆溢出

		-Xms
		
		-Xmx

#### 3.2、虚拟机栈和本地方法栈溢出

		1、参数：-Xss
		
		2、单线程： 实际一般抛出的异常都是StackOverflowError
		
		3、 多线程
		
			StackOverflowError
			
			OutOfMemoryError

#### 3.3、方法区和运行时常量池溢出

#### 3.4、本机直接内存溢出
		-XX：MaxDirectMemorySize
		特点

#三、*重点知识点实例*
#四、*参考资料*
#五、*思维扩展*
#六、*存在疑问*















 






