---
title: MySQL进阶整理
date: 2019-11-16 10:17:59
tags: 
categories: 
---
#一、*思维导图*
#*总知识点*
###一、mysql架构介绍（15分钟、5分钟交流）
####1、简介
	MySQL原本是一个开放源码的关系数据库管理系统，原开发者为瑞典的MySQL AB公司，该公司于2008年被（Sun Microsystems）收购。2009年，甲骨文公司（Oracle）收购昇阳微系统公司，MySQL成为Oracle旗下产品。
	MySQL在过去由于性能高、成本低、可靠性好，已经成为最流行的开源数据库，因此被广泛地应用在Internet上的中小型网站中。随着MySQL的不断成熟，它也逐渐用于更多大规模网站和应用，比如维基百科、Google和Facebook等网站。非常流行的开源软件组合LAMP中的“M”指的就是MySQL。
	但被甲骨文公司收购后，Oracle大幅调涨MySQL商业版的售价，且甲骨文公司不再支持另一个自由软件项目OpenSolaris的发展，因此导致自由软件社群们对于Oracle是否还会持续支持MySQL社群版（MySQL之中唯一的免费版本）有所隐忧，MySQL的创始人麦克尔·维德纽斯以MySQL为基础，成立分支计划MariaDB。而原先一些使用MySQL的开源软件逐渐转向MariaDB或其它的数据库。例如维基百科已于2013年正式宣布将从MySQL迁移到MariaDB数据库
	
####2、linux版安装
1、安装过程:
https://segmentfault.com/a/1190000018442644 
2、 mysql8.0安装可能出现问题:
https://blog.csdn.net/huangyuehong914/article/details/80503195  

####3、配置文件
https://blog.csdn.net/liuj2511981/article/details/8520910
https://juejin.im/post/5b7c0aabf265da438415b9eb
![Alt text](./1570967695045.png)

	介绍：
		1、认识mysql的主要的几种日志文件是什么及作用、路径、如何配置及查看
	命令：
		1、mysql -u root -p
		2、show variables like 'log_%';
		3、show variables like "%slow%";
		4、show variables like 'log_error';
		
	主要文件：
	1、二进制日志log-bin：
		1、恢复(recovery)： 某些数据的恢复需要二进制日志，如当一个数据库全备文件恢复后，我们可以通过二进制的日志进行 point-in-time的恢复
		2、复制(replication) : 通过复制和执行二进制日志使得一台远程的 MySQL 数据库(一般是slave 或者 standby) 与一台MySQL数据库(一般为master或者primary) 进行实时同步
		3、审计(audit)：用户可以通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入攻击
		
	2、错误日志log-error：
		默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等，当出现MySQL数据库不能正常启动时，第一个必须查找的文件就是错误日志文件，该文件记录了出错信息，能够帮助我们找到问题
	3、查询日志log：
		默认关闭，记录查询的sql语句，如果开启会降低mysql的整体性能，因为记录日志也是需要消耗系统资源
		
	4、数据文件（两种系统区别）
		1、linux:/var/lib/mysql/test
			配置文件：/etc/my.cnf
			日志文件：/var/log/mysqld.log
			服务启动脚本：/usr/lib/systemd/system/mysqld.service
			socket文件：/var/run/mysqld/mysqld.pid
		2、window:
			配置文件为 my.ini
			8.0:datadir 是：C:\ProgramData\MySQL\MySQL Server 8.0\data   #这是一个隐藏文件夹
			1、frm文件：存放表结构(暂时没有找到)
			2、myd文件：存放表数据	
			3、myi文件：存放表索引
					
				
####4、逻辑架构介绍
https://juejin.im/post/5c3ef9e051882525dc62de87#heading-14

![Alt text](./MySQL.png)
![Alt text](./mysql01.png)
![Alt text](./mysql查询过程.png)

	1、总体概览图
	2、各个层的解释分析
		1、MySQL逻辑架构整体分为三层，最上层为客户端层，并非MySQL所独有，诸如：连接处理、授权认证、安全等功能均在这一层处理。
		2、MySQL大多数核心服务均在中间这一层，包括查询解析、分析、优化、缓存、内置函数(比如：时间、数学、加密等函数)。
		所有的跨存储引擎的功能也在这一层实现：存储过程、触发器、视图等。
		3、最下层为存储引擎，其负责MySQL中的数据存储和提取。和Linux下的文件系统类似，每种存储引擎都有其优势和劣势。
	中间的服务层通过API与存储引擎通信，这些API接口屏蔽了不同存储引擎间的差异。	
	
####5、存储引擎
![Alt text](./1570972972410.png)

	介绍：接着上面的逻辑架构图，可以清晰的看到mysql的存在许多的存储引擎。
		1、什么叫存储引擎？有什么用？
		存储引擎说白了就是如何存储数据、如何为存储的数据建立索引和如何更新、查询数据等技术的实现方法。因为在关系数据库中数据的存储是以表的形式存储的，所以存储引擎也可以称为表类型（即存储和操作此表的类型）。在Oracle 和SQL Server等数据库中只有一种存储引擎，所有数据存储管理机制都是一样的。而MySql数据库提供了多种存储引擎。用户可以根据不同的需求为数据表选择不同的存储引擎，用户也可以根据自己的需要编写自己的存储引擎
		
		2、查看存储引擎的命令？
			show engines;
			Show create table tablename; 
			show table status like ‘tablename’\G显示表的当前状态值
		3、有哪些存储引擎、常见存储引擎？
			1.InnoDB 引擎(MySQL5.5以后默认使用)MySQL 5.5 及以后版本中的默认存储引擎，
			它的优点如下：
				1、灾难恢复性好（为什么这么说）
				2、支持事务
				3、使用行级锁
				4、支持外键关联
				5、支持热备份
				6、对于InnoDB引擎中的表，其数据的物理组织形式是簇表（Cluster Table），主键索引和数据是在一起的，数据按主键的顺序物理分布
			
			
			2.MyISAM引擎特性如下：
				1、不支持事务
				2、使用表级锁，并发性差
				3、主机宕机后，MyISAM表易损坏，灾难恢复性不佳
				4、可以配合锁，实现操作系统下的复制备份、迁移
				5、只缓存索引，数据的缓存是利用操作系统缓冲区来实现的。可能引发过多的系统调用且效率不佳
				6、数据紧凑存储，因此可获得更小的索引和更快的全表扫描性能

			
		4、如何选择适合的存储引擎？
			
	

####6、例子：一条sql查询执行过程及更新、删除过程


###二、索引优化分析
	在此，我们作为开发者，听着比较多关于mysql相关的内容最多：
	1、你这sql写着不好
	2、性能差sql查询慢
	3、sql索引失效导致全表扫描
	4、等等。。。。。。

	所以这个这章节会主要介绍以下几个内容：（会介绍下方法论及实例实践深入了解索引优化分析内容）
####1、性能下降sql慢
https://dbaplus.cn/news-11-1458-1.html

	经常会遇到DBA将一些执行效率较低的SQL发过来找开发人员分析，当我们拿到这个SQL语句之后，在对这些SQL进行分析之前，需要明确可能导致SQL执行性能下降的原因进行分析，执行性能下降可以体现在以下两个方面
	1、等待时间长（如何查看等待时间）
		锁表导致查询一直处于等待状态，后续我们从MySQL锁的机制去分析SQL执行的原理
	2、执行时间长
		分别有以下几个原因：
		1、运行环境的原因（可忽略）
			例如：磁盘空间满了
		2、查询语句写的烂
			例如：各种join、各种子查询、没建索引
		3、索引失效（分单值、复合）
			建了索引，但执行SQL的时候没用上
		4、关联查询太多join（设计缺陷或不得已的需求）
		5、服务器调优及各个参数设置（缓存、线程数等）
		
####2、常见通用join查询（介绍）
	介绍 ：在进行学习索引及性能分析及优化之后，我们先学习一些基本知识的，例如我们写sql经常的用到的join这块内容，大家是否有对join有清晰了解，例如存在几种join，应该如何选择合适的join等等。还有在我们写正常的sql语句的顺序和到服务层，优化器对我们sql是如何处理的，是否和我们写的sql顺序相同==
	
	1、几种join连接图
![Alt text](./Visual_SQL_JOINS_orig.jpg)

	2、MySQL 有几种Join,其底层实现原理是什么
		https://cloud.tencent.com/developer/article/1373839
		https://juejin.im/post/5bea59896fb9a049f23c49b8
	3、sql执行顺序
		1、手写
![Alt text](./1571150460144.png)

		2、机读
![Alt text](./1571150503799.png)

		3、总结
![Alt text](./1571150592237.png)


####3、索引简介（重点）
	介绍：有了前面知识的铺垫，进入我们重点，索引

		1、是什么
			MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构。提取句子主干，就可以得到索引的本质：索引是数据结构。
		2、优势
			1、减少查询需要扫描的数据量(加快了查询速度)
			2、减少服务器的排序操作和创建临时表的操作(加快了groupby和orderby等操作)
			3、将服务器的随机IO变为顺序IO(加快查询速度).
		3、劣势
			首先索引也是数据,也需要存储,因此会带来额外的存储空间占用.其次,在插入,更新和删除操作的同时,需要维护索引,因此会带来额外的时间开销.
		总结一下:
			1、索引占用磁盘或者内存空间
			2、减慢了插入更新操作的速度
			3、实际上,在一定数据范围内(索引没有超级多的情况下),建立索引带来的开销是远远小于它带来的好处的,但是我们仍然要防止索引的滥用


		4、索引存储分类：
			1、B+Tree 索引：最常见的索引类型，大部分引擎都支持B树索引。
			2、HASH 索引：只有Memory引擎支持，使用场景简单。
			3、R-Tree 索引(空间索引)：空间索引是MyISAM的一种特殊索引类型，主要用于地理空间数据类型。
			4、Full-text (全文索引)：全文索引也是MyISAM的一种特殊索引类型，主要用于全文索引，InnoDB从MYSQL5.6版本提供对全文索引的支持

			
		5、索引结构
http://blog.codinglabs.org/articles/theory-of-mysql-index.html
			
			1、什么是B+Tree的数据结构及原理
			2、两种主要存储引擎的实现B+Tree方式讨论聚集索引、非聚集索引及覆盖索引		
			3、MySQL中高性能使用索引的策略（实例）
		6、哪些情况需要创建索引
		7、哪些情况不要创建索引
		
####4、性能分析之Explain（重点）
		1、是什么
			使用Explain关键字可以模拟又花钱执行的SQL查询语句，从而知道MySQL是如何处理你的SQL语句，分析你的查询语句或是表结构的性能瓶颈
		2、能干嘛
			1、表的读取顺序
			2、数据读取操作的操作类型
			3、哪些索引可以使用
			4、哪些索引被实际使用
			5、表之间的引用
			6、每张表有哪些行被优化器查询
		3、怎么玩
		4、各字段解释
			1、id
				select查询的序列号，包含一组数字，表示查询中执行select子句或操作表顺序
				三种情况：
					1、id相同，执行顺序由上至下
					2、id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行
					3、id相同不同，同时存在
			2、select_type
				1、simple
				2、primary
				3、subquery
				4、derived
				5、union
				6、union result
				查询的类型，主要是用于区别。普通查询，联合查询，子查询等复杂查询
	
			3、table
			4、type
				1、all
				2、index
				3、range
				4、ref
				5、eq_ref
				6、const，system
				7、null
				访问类型排列：从最好到最差依次：system>const>eq_ref>ref>range>index>all
			5、possible_keys
				显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用
			6、key
				实际使用的索引，如果为null，则没有使用索引
				查询中若使用了覆盖索引，则该索引仅出现在key列表中
			7、key_len
				表示索引中使用的字节数，可通过该列计算查询中使用索引长度。在不损失精度情况下，长度越短越好。
				显示的值为索引字段的最大可能长度，并非实际使用长度。即是根据定义计算而得，而不是通过表内检索的
			8、ref
				显示索引的哪一列被使用，如果可能的话，是一个常数。哪些列或者常量被用于查询索引列上的值
			9、rows
				根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取行数
			10、Extra
	 5、例子
		
####5、索引优化（重点）
		1、索引分析
			1、单表
			2、两表
			3、三表
		2、索引失效（应该避免）：带头大哥不能死，中间兄弟不能断+例子
			1、全值匹配我最爱
			2、最佳左前缀法则
			3、不在索引列上做任何操作（计算、函数（自动or手动）类型转换），会导致索引失效而转向全表
			4、存储引擎不能使用索引中范围条件右边的列
			5、尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *
			6、mysql在使用不等于（！=或者<>）的时候无法索引会导致全表扫描
			7、is null ，is not null 也无法使用索引
			8、like以通配符开头（‘%abc’）mysql索引失效会变成全表扫描的操作
			9、字符串不加单引号索引失效
			10、少用or。用它来连接时会索引失效
		3、一般性建议
			1、对于单键索引，尽量选择针对对当前query过滤性更好索引
			2、在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好
			3、在选择组合索引的时候，尽量选择可以能够包含当前query中的where子句中更多字段的索引
			4、尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的	
		4、例子
		
		
		
###三、查询截取分析
####1、查询优化
		1、永远小表驱动大表（类似于嵌套循环nested Loop）
		2、order by 关键字优化
			1、order by 子句，尽量使用Index方式排序，避免使用FileSort方式
			2、尽可能在索引列上完成排序操作，遵循索引建的最佳左前缀
			3、如果不在索引列上，filesort有两种算法：mysql就要启动双路排序和单路
			
		3、group by 关键字优化
			1、是先排序后进行分组，遵循索引建的最佳坐前缀
			2、当无法使用索引列，增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置
			3、where 高于having，能写在where限定的条件就不要去having限定	
			
	
####2、慢查询日志
		1、是什么
		2、怎么玩
		3、日志分析工具mysqldumpslow
	
####3、slow profile
	
###四、mysql锁机制
####1、概述
####2、锁的分类
		1、表锁（偏读）
		2、行锁（偏写）
		
###五、主从复制
####1、复制的基本原理（图）
####2、复制的基本原则
		1、每个slave只有一个master
		2、每个slave只能有一个唯一的服务器ID
		3、每个master可以有多个salve
####3、复制的最大问题
		1、延时
####4、一主一从常见配置
	
	
###六、参考资料
mysql 参考资料：
1、书籍：高性能mysql
2、mysql视频参考：https://www.bilibili.com/watchlater/#/av29333200/p59
3、linux下mysql的安装: 
https://segmentfault.com/a/1190000018442644
https://blog.csdn.net/huangyuehong914/article/details/80503195