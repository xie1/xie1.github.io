---
title: 人人都是架构师
date: 2019-11-16 10:17:59
tags: 
categories: 
---
#一、*思维导图*
#*总知识点*
###1、分布式服务案例
####1.1、分布式系统的架构演变过程
#####1.1.1、单机系统
#####1.1.2、集群架构
#####1.1.3、拆系统之业务垂直化
	对业务系统完成拆分后，就意味着系统过渡到分布式系统、
#####1.1.4、为什么需要实现服务化架构
#####1.1.5、服务拆分粒度之微服务
####1.2、系统服务化需求
#####1.2.1、服务化与RPC协议
#####1.2.2、使用阿里分布式服务框架Dubbo实现服务化
#####1.2.3、警惕Dubbo因超时和重试引起的系统雪崩
	合理的设置服务的超时与重试机制，只有读服务开启了FailOver才会显得有意义。
#####1.2.4、服务治理方案
	1、服务的动态注册与发现
	2、服务的扩容评估
	3、服务的升/降级处理
	在管理控制台中服务治理包含的功能有：路由规则，动态配置，服务降级，访问控制，权限调节及负载均衡
#####1.2.5、关于服务化后的分布式事务问题
####1.3、分布式调用跟踪系统需求
	分布式调用跟踪系统其实就是一个监控平台，能够以可视化的方式展现跟踪到的每一个请求的完整调用链，以及收集调用链上每个服务的执行耗时，整合孤立日志等。	
#####1.3.2、基于Dubbo实现分布式调用跟踪系统方案
	通过拦截器Filter，对一次的服务调用进行处理，例如通过Trace中每一个Span过程分配一个全局唯一的TraceID
![Alt text](./1565512968579.png)

#####1.3.3、采样方案

###2、大流量限流/削峰案例
	大型互联网站通常采用的做法是通过扩容、动静分离、缓存、服务降级及限流五种常规手段来保护系统的稳定运行
####2.1、分布式系统为什么需要进行流量管制
![Alt text](./1565512998306.png)
####2.2、限流具体方案
#####2.2.1、常见的限流算法
	1、令牌桶算法
		主要用于限制流量的平均流入速率，而且还允许出现一定的程度的的突发流量
![Alt text](./1565575305553.png)

	2、漏桶算法
		1、可以以任意的速率流入桶中，以一定的速率流出
#####2.2.3、使用nginx实现接入层限流
#####2.2.4、使用计数器算法实现商品抢购限流
	抢购限流就是指在指定的SKU在单位时间内允许被抢购次数

	在生产环境中，将限流规则配置在配置中心中
	
####2.3、基于时间分片消峰
#####2.3.1、活动分时段进行消峰
#####2.3.2、通过答题验证实现消峰

####2.4、异步调用需求
#####2.4.1、使用MQ实现系统之间的解耦
#####2.4.2、使用Apache开源的ActiveMQ实现异步调用
#####2.4.3、使用阿里开源的Rocket实现互联网场景下的流量消峰——》暂未学习
	在某些特殊场景下，需要考虑顺序消息，事务消息，高吞吐量，高可用，及扩展性问题
	RocketMQ具备6个特点：
	1、支持顺序消息
	2、支持事务消息
	3、支持集群与广播模式
	4、亿级消息堆积能力
	5、完善的分布式特性
	6、支持Push与Pull两种消息订阅模式
![Alt text](./1565578609698.png)
#####2.4.4、基于MQ方案实现流量消峰的一些典型案例

###3、分布式配置管理服务案例
####3.1、本地配置
	1、将配置信息耦合在业务代码中
	2、将配置信息配置在配置文件中
#####3.1.1、将配置信息耦合在业务代码中
#####3.1.2、将配置信息配置在配置文件中
	通常做法是在系统启动的时候，通过JVM的启动参数设置系统属性（如 Java -Dconfig env="idc"）那么当系统运行的时候便可以通过System的getProperty(String key)方法获取指定的系统属性值来自动匹配当前环境，并加载配置文件中对应配置信息项
![Alt text](./1565580180524.png)

####3.2、集中式资源配置需求
	1、配置信息统一管理
	2、动态获取/更新配置信息
	3、降低运维人员的维护成本
	4、降低配置出错率
![Alt text](./1565580787867.png)


#####3.2.1、分布式一致性协调服务ZooKeeper
#####3.2.3、Zookeeper的基本使用技巧
#####3.2.4、基于Zookeeper实现分布式配置管理平台方案
![Alt text](./1565592379068.png)

	基于ZK实现分布式配置管理平台，还需要考虑并实现客户端的以下三点功能：
	1、信息配置管理界面
	2、订阅Znode中的配置信息
	3、容灾机制

#####3.2.5、从配置中心获取Spring的Bean定义实现Bean动态
#####3.2.6、容灾方案
![Alt text](./1565593350590.png)

	
#####3.2.7、使用淘宝Diamond实现分布式配置管理服务——》暂未学习

###4、大促场景下热点数据的读写优化
####4.1、缓存技术简介
	1、本地缓存
	2、分布式缓存
#####4.1.1、使用Ehcache实现数据缓存
#####4.1.2、LocalCache存在的弊端
	本地缓存会共享JVM有限的内存资源
#####4.1.3、off-heap（堆外内存）技术
	使用好处：
	1、减少GC次数或降低暂停时间
	2、可以扩展和使用更大内存空间
	3、省去物理内存与heap之间的数据复制步骤

####4.2、高性能分布式缓存Redis简介
#####4.2.1、使用Jedis客户端操作Redis
#####4.2.2、使用Redis集群实现数据水平化存储

####4.3、同一热卖商品高并发读需求
	为了解决分布式缓存可能存在的单点瓶颈，有两种解决方案：
	1、基于Redis集群的多写多读方案
	2、LocalCache结合Redis集群的多级Cache方案
#####4.3.1、Redis集群多写多读方案
	1、多写是在同一份商品数据被成功冗余存储到所有的缓存节点上
	2、多读，可以采用轮询或随机等方式实现数据访问
#####4.3.2、保障多写时的数据一致性
	使用Zookeeper来配置同一热卖商品的Key，此时客户端对其进行监听，一旦Watch到Znode发生了变化，所有的客户端全量更新本地持有的Key即可。
	以下三种情况会造成数据多写过程中生产失败：
	1、网络环境发生抖动
	2、Master/Slave切换
	3、Master/Slave全部宕机，集群环境重新分配Slot区间
![Alt text](./1565599730930.png)

#####4.3.3、LocalCache结合Redis集群的多级Cache方案
![Alt text](./1565600031590.png)

	
#####4.3.4、实时热点自动发现方案
![Alt text](./1565600256230.png)


####4.4、同一热卖商品高并发写需求
	在生产环境中实施多级Cache方案
#####4.4.1、InnoDB 行锁引起数据库TPS下降
	如果直接在数据库中扣减库存，应该如何避免商品超卖：
	解决方案:
		1、可以通过乐观锁来避免这个问题，简单来说就是在item表中建立一个version字段
		2、在扣减商品库存时，利用“实际库存数>=扣减库存数”作为条件来替代version匹配，防止商品超卖
#####4.4.2、在redis中扣减热卖商品库存方案
	因此在redis中实现库存扣减，其中数据库中的存储商品库存可以理解为实际库存，而Redis中存储的商品库存则为实时库存
	可以引入分布式锁，防止在大并发，redis扣减库存导致商品出现超卖现象
	分布式锁要满足三个要求：
	1、在任何情况下分布式锁都不能沦为系统的瓶颈
	2、不能产生死锁
	3、支持锁重入
	
	Redis锁的实现：使用Redisson是一个不错的方案
![Alt text](./1565603518809.png)


#####4.4.3、热卖商品库存扣减优化方案
	1、批量进行操作redis
![Alt text](./1565603725475.png)


	2、采用Redis提供的Watch命令来实现乐观锁
![Alt text](./1565603883153.png)


#####4.4.4、控制单机并发写流量方案
	1、单机排队串行写方案
	2、抢购限流方案
#####4.4.5、使用阿里开源的AliSQL数据库提升秒杀场景性能——》暂未学习


###5、数据库分库分表
####5.1、关系型数据库的架构演变
	性能瓶颈：
	1、大量的并发读/写操作，导致单库出现难以承受负载压力
	2、单表存储数据量过大，导致检索效率低下
#####5.1.1、数据库读写分离
#####5.1.2、数据库垂直分库
	根据企业自身业务的垂直划分，将原本冗余在单库中的数据表拆分到不同的业务库中，实现分而治之的数据管理和读写操作
#####5.1.3、数据库水平分开与水平分表
	主要是为了解决高并发场景下单库的性能瓶颈，并充分利用分布式的威力提升数据库的读、写性能
#####5.1.4、Mysql sharding（分布式）与MySQL Cluster的区别

####5.2、Sharding中间件
	1、明确定义SQL语句中的shard Key（路由条件）
	2、如何根据所定义的Shard Key进行数据路由，这需要自定义一套特定的路由算法和规则
#####5.2.1、常见的Sharding 中间件对比
#####5.2.2、Shark简介
#####5.2.3、Shark架构模型
![Alt text](./1565666215066.png)

#####5.2.4、使用Shark实现分库分表后的数据路由任务
	支持两类分库分表模式：
	1、单库夺标模式
	2、多开多库模式
#####5.2.5、分库分表后所带来的影响
	1、垂直分库分表所影响
		1、分布式事务  2、join 3、外键
	2、水平分库分表
		1、唯一id号没有保障
		2、多库查询
#####5.2.6、多机SequenceID的解决方案
#####5.2.7、使用Solr满足多维度的复杂条件查询
	使用场景：
	1、如果数据库的查询条件采用了like进行模糊查询
#####5.2.8、关于分布式事务


####5.3、数据库的HA方案
	三种成熟的方案：
	1、基于配置中心实现主从切除
	2、基于Keepalived实现主从切换
	3、基于HA实现主从切换
#####5.3.3、保障主从切换过程中数据的一致
	在高并发的情况下，主从复制延迟肯定是非常大，因此为了避免数据库分离后应有层无法从Slave拉到实时数据，通常情况是在写入Master之前也将同一份数据落到缓存中，以避免高并发情况下，从slave中获取不到指定的数据的情况发生

####5.4、订单业务冗余表需求
	通过冗余表
#####5.4.1、冗余表的实现方式
	冗余表可以解决满足订单业务分库分表后不同维度的查询需求。
	可以采用：
	1、数据异步写入
	2、数据同步写入

![Alt text](./1565669062468.png)
#####5.4.2、保障冗余表的数据一致性	
	1、线上补偿机制：

![Alt text](./1565669297014.png)

	2、线下补偿机制
![Alt text](./1565676604487.png)

